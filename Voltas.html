<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Platform</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --bg-white: #ffffff;
            --bg-light: #f9f9f9;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-700: #555555;
            --gray-900: #333333;
            --accent: #4a6fa5;
            --success: #4CAF50;
            --error: #f44336;
        }
        
        body {
            background-color: var(--bg-white);
            color: var(--gray-900);
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--gray-300);
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray-700);
            display: flex;
            align-items: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .view {
            display: none;
            padding: 20px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background-color: var(--bg-light);
            flex: 1;
        }
        
        .view.active {
            display: flex;
            flex-direction: column;
        }
        
        .btn {
            background-color: var(--gray-300);
            color: var(--gray-900);
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: var(--gray-200);
        }
        
        .btn-primary {
            background-color: var(--gray-700);
            color: var(--bg-white);
        }
        
        .btn-primary:hover {
            background-color: var(--gray-900);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 1rem;
            background-color: var(--bg-white);
        }
        
        .vault-card {
            background-color: var(--bg-white);
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .vault-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .vault-card h3 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .vault-meta {
            display: flex;
            justify-content: space-between;
            color: var(--gray-700);
            font-size: 0.9rem;
        }
        
        .message-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .message-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--bg-white);
        }
        
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: var(--gray-100);
            max-width: 80%;
        }
        
        .message.self {
            background-color: var(--gray-200);
            margin-left: auto;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: var(--gray-700);
        }
        
        .file-upload {
            margin: 15px 0;
            padding: 10px;
            border: 1px dashed var(--gray-300);
            border-radius: 4px;
            text-align: center;
            background-color: var(--bg-white);
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding: 8px;
            background-color: var(--gray-100);
            border-radius: 4px;
        }
        
        .file-preview img {
            max-width: 50px;
            max-height: 50px;
            margin-right: 10px;
            border-radius: 4px;
        }
        
        .encryption-indicator {
            display: flex;
            align-items: center;
            margin-top: 10px;
            color: var(--success);
            font-size: 0.9rem;
        }
        
        .encryption-indicator::before {
            content: "‚úì";
            margin-right: 5px;
            font-weight: bold;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid var(--gray-300);
            color: var(--gray-700);
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: var(--gray-900);
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            max-width: 400px;
        }
        
        .vault-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .private-vault {
            background-color: #e0f7fa;
            color: #00838f;
        }
        
        .public-vault {
            background-color: #f1f8e9;
            color: #689f38;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: var(--success);
        }
        
        .status-disconnected {
            background-color: var(--error);
        }
        
        .status-connecting {
            background-color: #ff9800;
        }
        
        .progress-container {
            margin-top: 10px;
            height: 5px;
            background-color: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .vault-id-display {
            font-size: 0.8rem;
            color: var(--gray-700);
            word-break: break-all;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-btn {
            background: var(--gray-300);
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-700);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        .url-display {
            background-color: var(--gray-100);
            padding: 10px;
            border-radius: 4px;
            margin: 15px 0;
            word-break: break-all;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <button id="headerBackBtn" class="back-btn" style="display: none;">‚Üê Back</button>
        <h1>The Platform</h1>
        <p>Secure Peer-to-Peer Communication</p>
    </header>
    
    <div class="app-container">
        <!-- Main View -->
        <div id="mainView" class="view active">
            <h2>Your Vaults</h2>
            <div id="vaultList" class="vault-list">
                <div class="empty-state">
                    <i>üîí</i>
                    <h3>No vaults yet</h3>
                    <p>Create or join a vault to start secure communication</p>
                </div>
            </div>
            <div class="actions">
                <button id="createPrivateVault" class="btn btn-primary">Create Private Vault</button>
                <button id="createPublicVault" class="btn">Create Public Vault</button>
                <button id="joinVault" class="btn">Join Vault</button>
            </div>
        </div>
        
        <!-- Create Vault View -->
        <div id="createVaultView" class="view">
            <h2>Create New Vault</h2>
            <div class="form-group">
                <label id="vaultNameLabel" for="vaultName">Vault Name (Only you will see this)</label>
                <input type="text" id="vaultName" placeholder="My Secret Conversations">
            </div>
            <div class="form-group">
                <label for="expiration">Expiration Time</label>
                <select id="expiration">
                    <option value="5">5 hours</option>
                    <option value="24">24 hours</option>
                    <option value="72">3 days</option>
                    <option value="168">7 days</option>
                    <option value="720">1 month (30 days)</option>
                    <option value="4320">6 months</option>
                    <option value="8760">1 year</option>
                    <option value="0">Forever</option>
                </select>
            </div>
            <div class="action-buttons">
                <button id="createVaultBtn" class="btn btn-primary">Create Vault</button>
                <button id="cancelCreate" class="btn">Cancel</button>
            </div>
        </div>
        
        <!-- Share Vault View -->
        <div id="shareVaultView" class="view">
            <h2>Your Vault is Ready!</h2>
            <div class="form-group">
                <label>Share this URL:</label>
                <div class="url-display" id="vaultUrlDisplay">Generating URL...</div>
            </div>
            <p id="vaultTypeInfo" class="vault-meta"></p>
            <div class="action-buttons">
                <button id="copyVaultUrl" class="btn btn-primary">Copy URL</button>
                <button id="goToVaultBtn" class="btn">Go to Vault</button>
                <button id="shareCancel" class="btn">Back to Main</button>
            </div>
        </div>
        
        <!-- Join Vault View -->
        <div id="joinVaultView" class="view">
            <h2>Join a Vault</h2>
            <div class="form-group">
                <label for="vaultUrl">Vault URL</label>
                <input type="text" id="vaultUrl" placeholder="https://theplatform.com/vault/abc123...">
            </div>
            <div class="form-group" id="privateNameGroup" style="display: none;">
                <label for="personalVaultName">Your Name for this Vault</label>
                <input type="text" id="personalVaultName" placeholder="My Chat with Alex">
            </div>
            <div class="action-buttons">
                <button id="joinVaultBtn" class="btn btn-primary">Join Vault</button>
                <button id="cancelJoin" class="btn">Cancel</button>
            </div>
        </div>
        
        <!-- Vault View -->
        <div id="vaultView" class="view">
            <h2 id="vaultTitle">Vault Name</h2>
            <div class="vault-meta">
                <div id="expirationInfo">Expires: Never</div>
                <div id="participants">Participants: <span id="participantCount">1</span></div>
            </div>
            
            <div class="message-container">
                <div class="message-list" id="messageList">
                    <!-- Messages will appear here -->
                </div>
                
                <div class="file-upload">
                    <label for="fileInput">Send file, photo, or audio:</label>
                    <input type="file" id="fileInput" multiple>
                    <div id="filePreview"></div>
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <textarea id="messageInput" placeholder="Type your secure message here..." rows="3"></textarea>
                </div>
                
                <div class="action-buttons">
                    <button id="sendMessageBtn" class="btn btn-primary">Send Encrypted Message</button>
                    <button id="leaveVault" class="btn">Leave Vault</button>
                </div>
            </div>
            
            <div class="encryption-indicator">All messages are end-to-end encrypted</div>
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting to peer network...</span>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">Vault created successfully!</div>
    
    <footer>
        a Prakhar Solanki creation
    </footer>
    
    <script>
        // Application state
        const state = {
            currentView: 'main',
            userId: null,
            vaults: [],
            currentVault: null,
            peer: null,
            connections: {},
            currentFile: null,
            vaultType: null
        };
        
        // PeerJS configuration
        const PEER_CONFIG = {
            host: '0.peerjs.com',
            port: 443,
            secure: true,
            debug: 2
        };
        
        // Initialize the application
        async function initApp() {
            // Load state from localStorage
            loadState();
            
            // Initialize PeerJS
            initPeerConnection();
            
            // Render initial view
            renderVaults();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for URL hash to auto-join a vault
            handleInitialVaultJoin();
            
            // Set up back button
            document.getElementById('headerBackBtn').addEventListener('click', navigateBack);
        }
        
        // Navigation history
        const navigationHistory = [];
        
        // Navigate to a view
        function navigateTo(view) {
            // Add current view to history
            if (state.currentView !== view) {
                navigationHistory.push(state.currentView);
            }
            
            changeView(view);
            updateBackButton();
        }
        
        // Navigate back
        function navigateBack() {
            if (navigationHistory.length > 0) {
                const prevView = navigationHistory.pop();
                changeView(prevView);
                updateBackButton();
            }
        }
        
        // Update back button visibility
        function updateBackButton() {
            const backBtn = document.getElementById('headerBackBtn');
            if (state.currentView === 'main') {
                backBtn.style.display = 'none';
            } else {
                backBtn.style.display = 'block';
            }
        }
        
        // Initialize PeerJS connection
        function initPeerConnection() {
            if (!state.userId) {
                state.userId = 'user-' + Math.random().toString(36).substr(2, 8);
                saveState();
            }
            
            state.peer = new Peer(state.userId, PEER_CONFIG);
            
            // Peer connection handlers
            state.peer.on('open', id => {
                console.log('Peer connected with ID:', id);
                updateConnectionStatus('connected', 'Connected to peer network');
            });
            
            state.peer.on('connection', conn => {
                console.log('Incoming connection from:', conn.peer);
                setupConnection(conn);
            });
            
            state.peer.on('error', err => {
                console.error('PeerJS error:', err);
                if (err.type === 'unavailable-id') {
                    // Generate a new ID if current one is taken
                    state.userId = 'user-' + Math.random().toString(36).substr(2, 8);
                    saveState();
                    initPeerConnection();
                }
                updateConnectionStatus('disconnected', 'Connection error: ' + err.message);
            });
            
            state.peer.on('disconnected', () => {
                console.log('Peer disconnected');
                updateConnectionStatus('disconnected', 'Disconnected from peer network');
                // Attempt to reconnect
                setTimeout(() => {
                    state.peer.reconnect();
                    updateConnectionStatus('connecting', 'Reconnecting...');
                }, 2000);
            });
        }
        
        // Set up a connection with another peer
        function setupConnection(conn) {
            conn.on('open', () => {
                console.log('Connection established with:', conn.peer);
                state.connections[conn.peer] = conn;
                
                // Handle incoming messages
                conn.on('data', data => {
                    handleIncomingData(data);
                });
                
                // Handle disconnection
                conn.on('close', () => {
                    console.log('Connection closed with:', conn.peer);
                    delete state.connections[conn.peer];
                    updateParticipantCount();
                });
                
                // If we're in a vault, send vault info to the new participant
                if (state.currentVault) {
                    conn.send({
                        type: 'vault-info',
                        vaultId: state.currentVault.id,
                        name: state.currentVault.personalName
                    });
                }
                
                updateParticipantCount();
            });
            
            conn.on('error', err => {
                console.error('Connection error:', err);
            });
        }
        
        // Handle incoming data
        function handleIncomingData(data) {
            if (!data || !state.currentVault) return;
            
            switch(data.type) {
                case 'message':
                    addMessageToVault({
                        id: 'msg-' + Date.now(),
                        sender: data.sender,
                        text: data.text,
                        timestamp: new Date(),
                        isFile: false
                    });
                    break;
                    
                case 'file-start':
                    state.currentFile = {
                        id: data.fileId,
                        name: data.name,
                        type: data.fileType,
                        size: data.size,
                        chunks: [],
                        received: 0
                    };
                    showNotification(`Receiving file: ${data.name}`);
                    break;
                    
                case 'file-chunk':
                    if (state.currentFile && state.currentFile.id === data.fileId) {
                        state.currentFile.chunks.push(data.chunk);
                        state.currentFile.received += data.chunk.byteLength;
                        
                        // Update progress
                        const percent = Math.floor((state.currentFile.received / state.currentFile.size) * 100);
                        document.getElementById('progressBar').style.width = `${percent}%`;
                        
                        if (state.currentFile.received >= state.currentFile.size) {
                            // File transfer complete
                            const file = new Blob(state.currentFile.chunks, {type: state.currentFile.type});
                            saveFile(file, state.currentFile.name);
                            
                            addMessageToVault({
                                id: 'file-' + Date.now(),
                                sender: data.sender,
                                fileName: state.currentFile.name,
                                fileType: state.currentFile.type,
                                fileSize: state.currentFile.size,
                                timestamp: new Date(),
                                isFile: true
                            });
                            
                            state.currentFile = null;
                            document.getElementById('progressContainer').style.display = 'none';
                            showNotification(`File received: ${state.currentFile.name}`);
                        }
                    }
                    break;
                    
                case 'vault-info':
                    if (state.currentVault && state.currentVault.id === data.vaultId) {
                        // Update participant count
                        updateParticipantCount();
                    }
                    break;
            }
        }
        
        // Create a vault
        function createVault(type, name, expiration) {
            const vaultId = 'vault-' + Math.random().toString(36).substr(2, 10);
            const expirationHours = parseInt(expiration);
            
            const vault = {
                id: vaultId,
                name: name,
                type: type,
                expiration: expirationHours,
                expirationDate: expirationHours === 0 ? null : 
                    new Date(Date.now() + expirationHours * 60 * 60 * 1000),
                participants: [state.userId],
                messages: [],
                personalName: name,
                creator: state.userId,
                isPrivate: type === 'private'
            };
            
            // Add to vaults
            state.vaults.push(vault);
            
            // Generate shareable URL
            let url = `${window.location.origin}${window.location.pathname}#/vault/${vaultId}/${state.userId}`;
            if (type === 'private') {
                url += '?private=true';
            }
            
            // Save state
            saveState();
            
            // Show share view
            document.getElementById('vaultUrlDisplay').textContent = url;
            document.getElementById('vaultTypeInfo').textContent = 
                `Type: ${type === 'private' ? 'Private Vault (Single-use)' : 'Public Vault (Multi-use)'}`;
            
            state.vaultType = type;
            navigateTo('shareVault');
        }
        
        // Join a vault
        function joinVault(vaultUrl, personalName) {
            // Extract vault ID from URL
            const match = vaultUrl.match(/vault\/([a-zA-Z0-9\-_]+)/);
            if (!match || match.length < 2) {
                showNotification('Invalid vault URL');
                return;
            }
            
            const vaultId = match[1];
            
            // Check if it's a private vault from URL
            const isPrivate = vaultUrl.includes('private=true');
            
            // Create new vault object
            const vault = {
                id: vaultId,
                name: isPrivate ? personalName : `Public Vault ${vaultId.substring(0, 8)}`,
                type: isPrivate ? 'private' : 'public',
                expiration: 168, // Default to 7 days
                expirationDate: new Date(Date.now() + 168 * 60 * 60 * 1000),
                participants: [state.userId],
                messages: [],
                personalName: isPrivate ? personalName : '',
                isPrivate: isPrivate
            };
            
            // Add to vaults
            state.vaults.push(vault);
            
            // Save state
            saveState();
            
            // Render vaults
            renderVaults();
            navigateTo('main');
            
            showNotification(`Joined ${isPrivate ? 'private' : 'public'} vault: ${vault.name}`);
            
            // Attempt to connect to vault creator
            const creatorId = vaultUrl.split('/').pop();
            if (creatorId && creatorId !== state.userId) {
                const conn = state.peer.connect(creatorId);
                setupConnection(conn);
            }
        }
        
        // Save state to localStorage
        function saveState() {
            localStorage.setItem('appState', JSON.stringify({
                userId: state.userId,
                vaults: state.vaults
            }));
        }
        
        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('appState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.userId = parsed.userId;
                state.vaults = parsed.vaults || [];
                
                // Convert expiration dates back to Date objects
                state.vaults.forEach(vault => {
                    if (vault.expirationDate) {
                        vault.expirationDate = new Date(vault.expirationDate);
                    }
                });
            }
        }
        
        // Render vaults list
        function renderVaults() {
            const vaultList = document.getElementById('vaultList');
            vaultList.innerHTML = '';
            
            if (state.vaults.length === 0) {
                vaultList.innerHTML = `
                    <div class="empty-state">
                        <i>üîí</i>
                        <h3>No vaults yet</h3>
                        <p>Create or join a vault to start secure communication</p>
                    </div>
                `;
                return;
            }
            
            state.vaults.forEach(vault => {
                const vaultCard = document.createElement('div');
                vaultCard.className = 'vault-card';
                vaultCard.dataset.id = vault.id;
                
                const expirationText = vault.expiration === 0 ? 
                    'Never expires' : 
                    `Expires: ${formatExpiration(vault.expiration)}`;
                
                const vaultType = vault.type === 'private' ? 
                    '<span class="vault-type private-vault">Private</span>' : 
                    '<span class="vault-type public-vault">Public</span>';
                
                vaultCard.innerHTML = `
                    <h3>${vault.name} ${vaultType}</h3>
                    <div class="vault-meta">
                        <div>${expirationText}</div>
                        <div>Participants: ${vault.participants.length}</div>
                    </div>
                    <div class="vault-id-display">ID: ${vault.id} 
                        <button class="copy-btn" data-id="${vault.id}">Copy URL</button>
                    </div>
                `;
                
                vaultCard.addEventListener('click', () => openVault(vault.id));
                vaultCard.querySelector('.copy-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyVaultUrl(vault.id);
                });
                
                vaultList.appendChild(vaultCard);
            });
        }
        
        // Open a vault
        function openVault(vaultId) {
            const vault = state.vaults.find(v => v.id === vaultId);
            if (!vault) return;
            
            state.currentVault = vault;
            
            document.getElementById('vaultTitle').textContent = vault.name;
            document.getElementById('expirationInfo').textContent = 
                `Expires: ${formatExpiration(vault.expiration)}`;
            document.getElementById('participantCount').textContent = 
                vault.participants.length;
            
            // Render messages
            renderMessages(vault.messages);
            
            // Broadcast connection to all participants
            broadcastVaultInfo();
            
            navigateTo('vault');
        }
        
        // Render messages
        function renderMessages(messages) {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';
            
            if (messages.length === 0) {
                messageList.innerHTML = `
                    <div class="empty-state">
                        <i>üí¨</i>
                        <h3>No messages yet</h3>
                        <p>Send a message to start the conversation</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === state.userId ? 'self' : ''}`;
                
                let content = '';
                if (msg.isFile) {
                    content = `
                        <div class="file-message">
                            <strong>üìé File:</strong> ${msg.fileName} (${formatFileSize(msg.fileSize)})
                            <div><small>${msg.fileType}</small></div>
                        </div>
                    `;
                } else {
                    content = `<div>${msg.text}</div>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span>${msg.sender === state.userId ? 'You' : 'Participant'}</span>
                        <span>${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    ${content}
                `;
                
                messageList.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        // Format expiration text
        function formatExpiration(expiration) {
            if (expiration === 0) return 'Never';
            
            const now = new Date();
            const expiryDate = new Date(now.getTime() + expiration * 60 * 60 * 1000);
            return expiryDate.toLocaleDateString();
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // Send a message
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            const fileInput = document.getElementById('fileInput');
            
            if (!text && fileInput.files.length === 0) return;
            
            if (fileInput.files.length > 0) {
                // Handle file upload
                sendFile(fileInput.files[0]);
                fileInput.value = '';
                document.getElementById('filePreview').innerHTML = '';
            } else {
                // Send text message
                const message = {
                    id: 'msg-' + Date.now(),
                    sender: state.userId,
                    text: text,
                    timestamp: new Date(),
                    isFile: false
                };
                
                // Add to current vault
                state.currentVault.messages.push(message);
                
                // Broadcast to all connections
                broadcastMessage({
                    type: 'message',
                    sender: state.userId,
                    text: text
                });
                
                // Save state
                saveState();
                
                // Render messages
                renderMessages(state.currentVault.messages);
                
                // Clear input
                messageInput.value = '';
            }
        }
        
        // Send a file
        async function sendFile(file) {
            if (!file) return;
            
            const fileId = 'file-' + Date.now();
            const CHUNK_SIZE = 16384; // 16KB chunks
            
            // Show file preview
            const filePreview = document.getElementById('filePreview');
            filePreview.innerHTML = '';
            
            const preview = document.createElement('div');
            preview.className = 'file-preview';
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);
            }
            
            const fileInfo = document.createElement('div');
            fileInfo.innerHTML = `
                <div><strong>${file.name}</strong></div>
                <div>${file.type} - ${formatFileSize(file.size)}</div>
            `;
            
            preview.appendChild(fileInfo);
            filePreview.appendChild(preview);
            
            // Show progress bar
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            // Broadcast file start
            broadcastMessage({
                type: 'file-start',
                fileId: fileId,
                name: file.name,
                fileType: file.type,
                size: file.size
            });
            
            // Read file and send in chunks
            const reader = new FileReader();
            let offset = 0;
            
            reader.onload = async function(e) {
                if (offset >= file.size) {
                    // File transfer complete
                    progressContainer.style.display = 'none';
                    showNotification(`File sent: ${file.name}`);
                    
                    // Add file message to vault
                    addMessageToVault({
                        id: fileId,
                        sender: state.userId,
                        fileName: file.name,
                        fileType: file.type,
                        fileSize: file.size,
                        timestamp: new Date(),
                        isFile: true
                    });
                    return;
                }
                
                const chunk = e.target.result;
                broadcastMessage({
                    type: 'file-chunk',
                    fileId: fileId,
                    chunk: chunk
                });
                
                // Update progress
                offset += chunk.byteLength;
                const percent = Math.floor((offset / file.size) * 100);
                progressBar.style.width = `${percent}%`;
                
                // Read next chunk
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };
            
            // Read first chunk
            const slice = file.slice(offset, offset + CHUNK_SIZE);
            reader.readAsArrayBuffer(slice);
        }
        
        // Add message to vault
        function addMessageToVault(message) {
            if (!state.currentVault) return;
            
            state.currentVault.messages.push(message);
            saveState();
            renderMessages(state.currentVault.messages);
        }
        
        // Broadcast message to all connections
        function broadcastMessage(data) {
            Object.values(state.connections).forEach(conn => {
                if (conn.open) {
                    conn.send(data);
                }
            });
        }
        
        // Broadcast vault info to all connections
        function broadcastVaultInfo() {
            if (!state.currentVault) return;
            
            broadcastMessage({
                type: 'vault-info',
                vaultId: state.currentVault.id,
                name: state.currentVault.personalName
            });
        }
        
        // Update participant count
        function updateParticipantCount() {
            if (!state.currentVault) return;
            
            const count = Object.keys(state.connections).length + 1;
            document.getElementById('participantCount').textContent = count;
        }
        
        // Update connection status UI
        function updateConnectionStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            switch(status) {
                case 'connected':
                    statusDot.classList.add('status-connected');
                    break;
                case 'disconnected':
                    statusDot.classList.add('status-disconnected');
                    break;
                case 'connecting':
                    statusDot.classList.add('status-connecting');
                    break;
            }
            
            statusText.textContent = text;
        }
        
        // Save file to disk
        function saveFile(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }
        
        // Copy vault URL to clipboard
        function copyVaultUrl(vaultId) {
            const vault = state.vaults.find(v => v.id === vaultId);
            if (!vault) return;
            
            let url = `${window.location.origin}${window.location.pathname}#/vault/${vaultId}/${state.userId}`;
            if (vault.type === 'private') {
                url += '?private=true';
            }
            
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Vault URL copied to clipboard!');
            });
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Change application view
        function changeView(viewName) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`${viewName}View`).classList.add('active');
            state.currentView = viewName;
            
            // Clear any file previews when leaving vault view
            if (viewName !== 'vault') {
                document.getElementById('filePreview').innerHTML = '';
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('messageInput').value = '';
            }
        }
        
        // Handle file selection
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const filePreview = document.getElementById('filePreview');
            
            filePreview.innerHTML = '';
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    preview.appendChild(img);
                }
                
                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <div><strong>${file.name}</strong></div>
                    <div>${file.type} - ${formatFileSize(file.size)}</div>
                `;
                
                preview.appendChild(fileInfo);
                filePreview.appendChild(preview);
            }
        }
        
        // Handle initial vault join from URL
        function handleInitialVaultJoin() {
            if (window.location.hash.startsWith('#/vault/')) {
                const parts = window.location.hash.split('/');
                if (parts.length >= 3) {
                    const vaultId = parts[2];
                    const creatorId = parts[3];
                    const isPrivate = window.location.hash.includes('private=true');
                    
                    const vault = state.vaults.find(v => v.id === vaultId);
                    if (vault) {
                        openVault(vaultId);
                    } else {
                        navigateTo('joinVault');
                        document.getElementById('vaultUrl').value = window.location.href;
                        
                        // Show personal name field only for private vaults
                        document.getElementById('privateNameGroup').style.display = 
                            isPrivate ? 'block' : 'none';
                    }
                    
                    // Connect to the creator
                    if (creatorId && creatorId !== state.userId) {
                        const conn = state.peer.connect(creatorId);
                        setupConnection(conn);
                    }
                }
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('createPrivateVault').addEventListener('click', () => {
                document.getElementById('vaultNameLabel').textContent = 'Vault Name (Only you will see this)';
                navigateTo('createVault');
                state.vaultType = 'private';
            });
            
            document.getElementById('createPublicVault').addEventListener('click', () => {
                document.getElementById('vaultNameLabel').textContent = 'Vault Name (Visible to all participants)';
                navigateTo('createVault');
                state.vaultType = 'public';
            });
            
            document.getElementById('joinVault').addEventListener('click', () => {
                document.getElementById('privateNameGroup').style.display = 'none';
                navigateTo('joinVault');
            });
            
            document.getElementById('createVaultBtn').addEventListener('click', () => {
                const name = document.getElementById('vaultName').value.trim();
                const expiration = document.getElementById('expiration').value;
                
                if (!name) {
                    showNotification('Please enter a vault name');
                    return;
                }
                
                createVault(state.vaultType, name, expiration);
            });
            
            document.getElementById('cancelCreate').addEventListener('click', navigateBack);
            
            document.getElementById('joinVaultBtn').addEventListener('click', () => {
                const url = document.getElementById('vaultUrl').value.trim();
                const name = document.getElementById('personalVaultName').value.trim();
                const isPrivate = url.includes('private=true');
                
                if (!url) {
                    showNotification('Please enter a vault URL');
                    return;
                }
                
                if (isPrivate && !name) {
                    showNotification('Please enter a name for this private vault');
                    return;
                }
                
                joinVault(url, name);
            });
            
            document.getElementById('cancelJoin').addEventListener('click', navigateBack);
            
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            
            document.getElementById('leaveVault').addEventListener('click', () => {
                navigateTo('main');
            });
            
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            document.getElementById('copyVaultUrl').addEventListener('click', () => {
                const url = document.getElementById('vaultUrlDisplay').textContent;
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('URL copied to clipboard!');
                });
            });
            
            document.getElementById('goToVaultBtn').addEventListener('click', () => {
                const vaultId = document.getElementById('vaultUrlDisplay').textContent
                    .match(/vault\/([a-zA-Z0-9\-_]+)/)[1];
                openVault(vaultId);
            });
            
            document.getElementById('shareCancel').addEventListener('click', () => {
                navigateTo('main');
            });
        }
        
        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
